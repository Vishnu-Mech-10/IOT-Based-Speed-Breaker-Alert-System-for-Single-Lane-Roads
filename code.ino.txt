#include <SoftwareSerial.h>

#define trigPin 9
#define echoPin 10
#define pirPin 8
#define buzzerPin 13
#define gsmRx 7  // Arduino RX <- GSM TX
#define gsmTx 6  // Arduino TX -> GSM RX

SoftwareSerial gsmSerial(gsmRx, gsmTx);

float distance;
float previousDistance;
const float detectionRange = 50.0;
const float movementThreshold = 2.0;
int pirState = LOW;
bool messageSent = false;

void setup() {
  Serial.begin(9600);
  gsmSerial.begin(9600);

  pinMode(trigPin, OUTPUT);
  pinMode(echoPin, INPUT);
  pinMode(pirPin, INPUT);
  pinMode(buzzerPin, OUTPUT);

  delay(1000);
  Serial.println("System Initialized.");
}

void loop() {
  distance = getDistance();
  pirState = digitalRead(pirPin);

  Serial.print("Distance: ");
  Serial.print(distance);
  Serial.println(" cm");

  if (distance <= detectionRange) {
    Serial.println("Object within 50 cm!");

    if (pirState == HIGH) {
      Serial.println("PIR: Motion Detected!");

      if (abs(distance - previousDistance) > movementThreshold) {
        Serial.println("Object is Moving!");
        digitalWrite(buzzerPin, HIGH);

        if (!messageSent) {
          sendSMS(distance);
          messageSent = true;  // Avoid spamming SMS
        }

      } else {
        Serial.println("Object Detected but Stationary.");
        digitalWrite(buzzerPin, LOW);
      }

      previousDistance = distance;
    } else {
      Serial.println("PIR: No Motion.");
      digitalWrite(buzzerPin, LOW);
      messageSent = false;
    }

  } else {
    Serial.println("No object nearby.");
    digitalWrite(buzzerPin, LOW);
    messageSent = false;
    previousDistance = detectionRange;
  }

  delay(500);
}

// Function to measure distance using HC-SR04
float getDistance() {
  long duration;
  float dist;

  digitalWrite(trigPin, LOW);
  delayMicroseconds(2);
  digitalWrite(trigPin, HIGH);
  delayMicroseconds(10);
  digitalWrite(trigPin, LOW);

  duration = pulseIn(echoPin, HIGH);
  dist = (duration * 0.0343) / 2;

  return dist;
}

// Function to send SMS using SIM800L
void sendSMS(float dist) {
  gsmSerial.println("AT+CMGF=1");    // Set SMS text mode
  delay(500);
  gsmSerial.println("AT+CMGS=\"+91XXXXXXXXXX\""); // Replace with your phone number
  delay(500);
  gsmSerial.print("Alert: Object moving within 50 cm!\nCurrent distance: ");
  gsmSerial.print(dist);
  gsmSerial.println(" cm.");
  delay(500);
  gsmSerial.write(26); // ASCII code of CTRL+Z to send message
  Serial.println("SMS Sent.");
  delay(2000);
}